%%% a basic introduction to Nexus

Today, data recorded during synchrotron experiments is typically stored in
individual binary image files and/or as flat ASCII files. 
Figure~\ref{fig:nxintro:old_fstree} shows the typicall directory structure of
such a setup. The ASCII file stores scalar data while the detector data is
stored in a separate directory as image files (here TIFF).
Such an approach leads to technical and organizational problems
\begin{enumerate}
\item when the number of image files grows large the performance of most file
systems degenerate 
\item to access data in an individual image file a new file handler has to be
created 
\item image and scalar data is stored in different files which increases the
managements efforts to keep related information together.
\end{enumerate}
%%%---------------------------------------------------------------------------
\begin{figure}[tb]
    \centering
    \begin{minipage}[c]{0.5\linewidth}
    \centering
    \begin{tikzpicture}
        [ every node/.style = {draw=black,thick,anchor=west,minimum width=3cm,
                               minimum height=0.5cm},
          directory node/.style = {draw=blue},
          grow via three points={ one child at (0.5,-0.8) and two children at
          (0.5,-0.8) and (0.5,-1.6)},
          edge from parent path = { (\tikzparentnode.south) |- (\tikzchildnode.west)}]
        \node[directory node]{{\tt run\_01}}
        child { node {{\tt ASCII data}}}
        child { node [directory node] {{\tt images}} 
            child{ node {{\tt image\_001.tif}}}
            child{ node {{\tt image\_002.tif}}}
            child{ node {\dots}}
            child{ node {{\tt image\_100.tif}}}
        }
        child [missing] {}
        child [missing] {}
        child [missing] {}
        child [missing] {};
    \end{tikzpicture}
    %%\resizebox{\linewidth}{!}{\includegraphics{pics/old_fstree.pdf}}
    \end{minipage}
    \hfill
    \begin{minipage}[c]{0.48\linewidth}
    \caption{{\small A typical directory structure used at todays synchrotron
    experiments. Scalar data is stored in a single ASCII file while detector
    data is stored as individual image files in a separate directory.}}
    \label{fig:nxintro:old_fstree}
    \end{minipage}
\end{figure}
%%%---------------------------------------------------------------------------

\nexus\ is a binary file format which attempts to solve all of these problems.
\nexus\ can keep scalar and multidimensional data within a single file and allows
to organize the data within the file in a tree like mannger. Additional
attributes can be attached to each object in a file, storing metadata which might
be required for later analysis. It must be noted that \nexus\ is not a
physical file format itself. It is rather a set of rules how data must be
organized within a particular format in order to become a valid Nexus file.
Currently the following physical file formats are supported by the original
Nexus API
\begin{itemize}
\item XML -- only used for file structure validation
\item HDF4 -- for historical reasons, should not be used for new data
\item HDF5 -- the current standard storage backend for Nexus files. 
\end{itemize}
One of the aims of \libpniio\ is to provide an abstraction layer between the
user and the storage backend. As \libpniio\ currently supports only HDF5 this is
rather artificial. However, \libpniio\ provides the architecture to include
other file formats to be used with \nexus\ too. 
There has been a lot of confusion what physical file format \nexus\ files are.
Many users think that \nexus\ has its own phyisical file format. This is in fact
not true. Just to avoid any further confusion for the reader let me make this
clear once and for all
\begin{quote}
\huge\sffamily\textbf{Every \nexus\ file written by \libpniio\ is also a valid HDF5 file!}
\todo[caption={fix quote},inline]{This quote needs better formating. Maybe the
text should go into a box and the margins to the surrounding text must be
bigger}
\end{quote}

%%%===========================================================================
\section{The Nexus layer model}

%%%---------------------------------------------------------------------------
\begin{figure}[tb]
    \centering
    \begin{minipage}[c]{0.5\linewidth}
    \centering
    \begin{tikzpicture}
       [layer/.style={fill=desycyan,shape=rectangle,draw=black,
                      minimum width=0.9\linewidth,
                      minimum height=1cm,
                      text=desywhite,align=left,
                      rounded corners=2mm}]
       \matrix[row sep=0.3cm]{
        \node [layer] { \textsf{\textbf{ Layer 3: application definitions}}}; \\
        \node [layer] { \textsf{\textbf{ Layer 2: base classes}}}; \\
        \node [layer] { \textsf{\textbf{ Layer 1: basic objects}}}; \\
        };
    \end{tikzpicture}
    \end{minipage}
    \hfill
    \begin{minipage}[c]{0.45\linewidth}
    \caption{{\small Nexus can be considered to consist of three layers where
    each layer represents a particular level of abstraction.}}
    \label{fig:nxintro:layers}
    \end{minipage}
\end{figure}
%%%---------------------------------------------------------------------------
As already mentioned in the previous section, \nexus\ can be considered as a set
of rules describing the logical organization of data within a file. 
\nexus, for this purpose, utilizes types defined in three different layers as 
shown in Fig.~\ref{fig:nxintro:layers}.
Each group of types defined in a layer is used for a particular purpose. Layer~1
provides the basic brick-stones from which the \nexus\ standard is build of. 
Layer~2 provides collections of Layer~1 instances representing concrete beamline
components as well as abstract concepts. Layer~3 finally can be used to define 
file formats for particular experimental techniques. 

\subsection{Layer 1 objects}

%%%---------------------------------------------------------------------------
\begin{figure}[tb]
    \centering
    \begin{minipage}[c]{0.6\linewidth}
    \centering
    \begin{tikzpicture}
        [element/.style={fill=desyorange,text=desywhite,
                         shape=ellipse,minimum width=3cm}]

         \node [element] (group) at (180:2){\textsf{\textbf{NXgroup}}};
         \node [element] (field) at (0:2) {\textsf{\textbf{NXfield}}};
         \node [element] (attribute) at (270:2){\textsf{\textbf{NXattribute}}};

         \path (field.west) edge 
                node[very near end,above] {$1$} 
                node[very near start,above] {$n$} 
                (group.east);
        \path (field.south) edge 
                node[very near start,right] {$1$} 
                node[very near end,right] {$n$} 
                (attribute.north east);
        \path (group.south) edge 
                node[very near start,left] {$1$} 
                node[very near end,left] {$n$} 
        (attribute.north west);
        \path (group) edge [in=30,out=60,loop above] node [above] {$n$} ();
    \end{tikzpicture}
    %%\resizebox{\linewidth}{!}{\includegraphics{pics/layer1.pdf}}
    \end{minipage}
    \hfill
    \begin{minipage}[c]{0.39\linewidth}
    \caption{{\small The basic objects of the first layer in the Nexus object
    model and their relation to each other.}}
    \label{fig:nxintro:layer1}
    \end{minipage}
\end{figure}
%%%---------------------------------------------------------------------------

The first layer in the \nexus\ layer model provides the fundamental types used 
to define the organizational structure of data in a file.
Figure~\ref{fig:nxintro:layer1} shows an overview of relation between the basic
Layer~1 objects types.
\begin{center}
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{m{0.2\linewidth}m{0.6\linewidth}}
    \textbf{NXgroup} &  is a container which can hold instances of fields and 
        other groups. \\
    \textbf{NXfield}  & stores numerical and other data. \\
    \textbf{NXattribute} & instances of NXgroup and NXfield can be enhanced with
        attributes which can store additional metadata about an object.
\end{tabular}
\end{center}
Attributes behave a little like fields as will be shown later. These three types
form the basement for all other objects in the above layers. 
It should be mentioned that attributes are heavily used by the NIAC to add
metadata to a group or field. It is thus not wise to make too extensive use of
attributes as a Nexus user as it my cause name clashes with future attributes
defined by the NIAC.

The focus of \libpniio\ is this first layer of the \nexus\ hierarchy.

\subsection{Layer 2 objects}

Objects from the second layer are composites of the types provided by the first
layer. They describe logical or physical entities at a beamline. 
These range from the very concrete objects like undulators or detectors to
abstract concepts like \emph{entries} and \emph{subentries}. 
The available objects from Layer 2 are defined in the Nexus Base class
catalogue.


\subsection{Layer 3 objects}

The third layer finally provides concepts to standardize the structure of a
Nexus data tree for particular scientific applications and methods. 
These so called \emph{Application Definitions} are defined by the NIAC in
collaboration with the scientific community.

